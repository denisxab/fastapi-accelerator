<!doctype html><html lang=ru class=no-js> <head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><link href=https://denisxab.github.io/fastapi-accelerator/test_logic/ rel=canonical><link href=../business_logic/ rel=prev><link href=../code_docs/ rel=next><link rel=icon href=../assets/images/favicon.png><meta name=generator content="mkdocs-1.6.1, mkdocs-material-9.5.38"><title>Testing logic - Fastapi Accelerator</title><link rel=stylesheet href=../assets/stylesheets/main.8c3ca2c6.min.css><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback"><style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style><link rel=stylesheet href=../assets/_mkdocstrings.css><script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script></head> <body dir=ltr> <input class=md-toggle data-md-toggle=drawer type=checkbox id=__drawer autocomplete=off> <input class=md-toggle data-md-toggle=search type=checkbox id=__search autocomplete=off> <label class=md-overlay for=__drawer></label> <div data-md-component=skip> <a href=#_1 class=md-skip> Перейти к содержанию </a> </div> <div data-md-component=announce> </div> <header class="md-header md-header--shadow" data-md-component=header> <nav class="md-header__inner md-grid" aria-label="Верхний колонтитул"> <a href=.. title="Fastapi Accelerator" class="md-header__button md-logo" aria-label="Fastapi Accelerator" data-md-component=logo> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg> </a> <label class="md-header__button md-icon" for=__drawer> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg> </label> <div class=md-header__title data-md-component=header-title> <div class=md-header__ellipsis> <div class=md-header__topic> <span class=md-ellipsis> Fastapi Accelerator </span> </div> <div class=md-header__topic data-md-component=header-topic> <span class=md-ellipsis> Testing logic </span> </div> </div> </div> <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script> <div class=md-header__option> <div class=md-select> <button class="md-header__button md-icon" aria-label="Выберите язык"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="m12.87 15.07-2.54-2.51.03-.03A17.5 17.5 0 0 0 14.07 6H17V4h-7V2H8v2H1v2h11.17C11.5 7.92 10.44 9.75 9 11.35 8.07 10.32 7.3 9.19 6.69 8h-2c.73 1.63 1.73 3.17 2.98 4.56l-5.09 5.02L4 19l5-5 3.11 3.11zM18.5 10h-2L12 22h2l1.12-3h4.75L21 22h2zm-2.62 7 1.62-4.33L19.12 17z"/></svg> </button> <div class=md-select__inner> <ul class=md-select__list> <li class=md-select__item> <a href=./ hreflang=ru class=md-select__link> Русский </a> </li> <li class=md-select__item> <a href=../en/test_logic/ hreflang=en class=md-select__link> English </a> </li> </ul> </div> </div> </div> <label class="md-header__button md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg> </label> <div class=md-search data-md-component=search role=dialog> <label class=md-search__overlay for=__search></label> <div class=md-search__inner role=search> <form class=md-search__form name=search> <input type=text class=md-search__input name=query aria-label=Поиск placeholder=Поиск autocapitalize=off autocorrect=off autocomplete=off spellcheck=false data-md-component=search-query required> <label class="md-search__icon md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg> </label> <nav class=md-search__options aria-label=Поиск> <button type=reset class="md-search__icon md-icon" title=Очистить aria-label=Очистить tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg> </button> </nav> </form> <div class=md-search__output> <div class=md-search__scrollwrap tabindex=0 data-md-scrollfix> <div class=md-search-result data-md-component=search-result> <div class=md-search-result__meta> Инициализация поиска </div> <ol class=md-search-result__list role=presentation></ol> </div> </div> </div> </div> </div> </nav> </header> <div class=md-container data-md-component=container> <main class=md-main data-md-component=main> <div class="md-main__inner md-grid"> <div class="md-sidebar md-sidebar--primary" data-md-component=sidebar data-md-type=navigation> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--primary" aria-label=Навигация data-md-level=0> <label class=md-nav__title for=__drawer> <a href=.. title="Fastapi Accelerator" class="md-nav__button md-logo" aria-label="Fastapi Accelerator" data-md-component=logo> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg> </a> Fastapi Accelerator </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=.. class=md-nav__link> <span class=md-ellipsis> Home </span> </a> </li> <li class=md-nav__item> <a href=../info_files/ class=md-nav__link> <span class=md-ellipsis> File descriptions </span> </a> </li> <li class=md-nav__item> <a href=../business_logic/ class=md-nav__link> <span class=md-ellipsis> Business logic </span> </a> </li> <li class="md-nav__item md-nav__item--active"> <input class="md-nav__toggle md-toggle" type=checkbox id=__toc> <label class="md-nav__link md-nav__link--active" for=__toc> <span class=md-ellipsis> Testing logic </span> <span class="md-nav__icon md-icon"></span> </label> <a href=./ class="md-nav__link md-nav__link--active"> <span class=md-ellipsis> Testing logic </span> </a> <nav class="md-nav md-nav--secondary" aria-label=Содержание> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> Содержание </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#_1 class=md-nav__link> <span class=md-ellipsis> Зачем и как писать тесты </span> </a> </li> <li class=md-nav__item> <a href=#_2 class=md-nav__link> <span class=md-ellipsis> Предварительная настройка для тестирования </span> </a> </li> <li class=md-nav__item> <a href=#_3 class=md-nav__link> <span class=md-ellipsis> Основные компоненты для тестирования </span> </a> </li> <li class=md-nav__item> <a href=#_4 class=md-nav__link> <span class=md-ellipsis> Подробнее про компоненты для тестирования </span> </a> <nav class=md-nav aria-label="Подробнее про компоненты для тестирования"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#fixture-client class=md-nav__link> <span class=md-ellipsis> Fixture - client </span> </a> </li> <li class=md-nav__item> <a href=#decorator-client_auth_jwt class=md-nav__link> <span class=md-ellipsis> Decorator - @client_auth_jwt </span> </a> </li> <li class=md-nav__item> <a href=#decorator-apply_fixture_db class=md-nav__link> <span class=md-ellipsis> Decorator - @apply_fixture_db </span> </a> </li> <li class=md-nav__item> <a href=#decorator-patch_integration class=md-nav__link> <span class=md-ellipsis> Decorator - @patch_integration </span> </a> </li> <li class=md-nav__item> <a href=#context-manager-track_queries class=md-nav__link> <span class=md-ellipsis> Context manager - track_queries </span> </a> </li> <li class=md-nav__item> <a href=#func-check_response_json class=md-nav__link> <span class=md-ellipsis> Func - check_response_json </span> </a> </li> <li class=md-nav__item> <a href=#_5 class=md-nav__link> <span class=md-ellipsis> Тестирование через классы </span> </a> <nav class=md-nav aria-label="Тестирование через классы"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#basepytest class=md-nav__link> <span class=md-ellipsis> Класс BasePytest </span> </a> </li> <li class=md-nav__item> <a href=#baseauthjwtpytest class=md-nav__link> <span class=md-ellipsis> Класс BaseAuthJwtPytest </span> </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#_6 class=md-nav__link> <span class=md-ellipsis> Примеры тестов </span> </a> <nav class=md-nav aria-label="Примеры тестов"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#_7 class=md-nav__link> <span class=md-ellipsis> Классическая тестовой функции </span> </a> </li> <li class=md-nav__item> <a href=#_8 class=md-nav__link> <span class=md-ellipsis> Классический тестовый класс </span> </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../code_docs/ class=md-nav__link> <span class=md-ellipsis> Code Docs </span> </a> </li> <li class=md-nav__item> <a href=../plan/ class=md-nav__link> <span class=md-ellipsis> Plan </span> </a> </li> <li class=md-nav__item> <a href=../about/ class=md-nav__link> <span class=md-ellipsis> About </span> </a> </li> </ul> </nav> </div> </div> </div> <div class="md-sidebar md-sidebar--secondary" data-md-component=sidebar data-md-type=toc> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--secondary" aria-label=Содержание> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> Содержание </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#_1 class=md-nav__link> <span class=md-ellipsis> Зачем и как писать тесты </span> </a> </li> <li class=md-nav__item> <a href=#_2 class=md-nav__link> <span class=md-ellipsis> Предварительная настройка для тестирования </span> </a> </li> <li class=md-nav__item> <a href=#_3 class=md-nav__link> <span class=md-ellipsis> Основные компоненты для тестирования </span> </a> </li> <li class=md-nav__item> <a href=#_4 class=md-nav__link> <span class=md-ellipsis> Подробнее про компоненты для тестирования </span> </a> <nav class=md-nav aria-label="Подробнее про компоненты для тестирования"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#fixture-client class=md-nav__link> <span class=md-ellipsis> Fixture - client </span> </a> </li> <li class=md-nav__item> <a href=#decorator-client_auth_jwt class=md-nav__link> <span class=md-ellipsis> Decorator - @client_auth_jwt </span> </a> </li> <li class=md-nav__item> <a href=#decorator-apply_fixture_db class=md-nav__link> <span class=md-ellipsis> Decorator - @apply_fixture_db </span> </a> </li> <li class=md-nav__item> <a href=#decorator-patch_integration class=md-nav__link> <span class=md-ellipsis> Decorator - @patch_integration </span> </a> </li> <li class=md-nav__item> <a href=#context-manager-track_queries class=md-nav__link> <span class=md-ellipsis> Context manager - track_queries </span> </a> </li> <li class=md-nav__item> <a href=#func-check_response_json class=md-nav__link> <span class=md-ellipsis> Func - check_response_json </span> </a> </li> <li class=md-nav__item> <a href=#_5 class=md-nav__link> <span class=md-ellipsis> Тестирование через классы </span> </a> <nav class=md-nav aria-label="Тестирование через классы"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#basepytest class=md-nav__link> <span class=md-ellipsis> Класс BasePytest </span> </a> </li> <li class=md-nav__item> <a href=#baseauthjwtpytest class=md-nav__link> <span class=md-ellipsis> Класс BaseAuthJwtPytest </span> </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#_6 class=md-nav__link> <span class=md-ellipsis> Примеры тестов </span> </a> <nav class=md-nav aria-label="Примеры тестов"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#_7 class=md-nav__link> <span class=md-ellipsis> Классическая тестовой функции </span> </a> </li> <li class=md-nav__item> <a href=#_8 class=md-nav__link> <span class=md-ellipsis> Классический тестовый класс </span> </a> </li> </ul> </nav> </li> </ul> </nav> </div> </div> </div> <div class=md-content data-md-component=content> <article class="md-content__inner md-typeset"> <h1>Testing logic</h1> <h2 id=_1>Зачем и как писать тесты</h2> <p>Рассмотрим тестирование: REST API, использующего реляционную СУБД и возвращающего ответы в формате JSON.</p> <p>Это один из наиболее распространенных подходов к интеграционному тестированию, который эмулирует ручную проверку API методов. Такой подход позволяет покрыть значительную часть бизнес-логики тестами, поэтому автоматизация тестирования API – хороший старт. Эти тесты не только воспроизводят ручное тестирование, но и позволяют проверять побочные эффекты в базе данных, такие как создание новых записей после выполнения POST-запросов.</p> <p>Реализовать такие тесты в <code>Django</code> достаточно просто благодаря встроенным инструментам, однако в <code>FastAPI</code> эта задача требует большего внимания. Поэтому я разработал компоненты, которые позволяют создавать интеграционные тесты API на <code>FastAPI</code> так же удобно и быстро, как и в <code>Django</code>.</p> <h2 id=_2>Предварительная настройка для тестирования</h2> <ol> <li>Установка</li> </ol> <div class=highlight><pre><span></span><code>poetry<span class=w> </span>add<span class=w> </span>pytest<span class=w> </span>pytest-asyncio<span class=w> </span>httpx
</code></pre></div> <ol> <li>Создать файл <code>app/pytest.ini</code></li> </ol> <div class=highlight><pre><span></span><code><span class=k>[pytest]</span>
<span class=c1>; Доп аргументы к запуску</span>
<span class=na>addopts</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>-v -l -x -s --lf --disable-warnings</span>

<span class=c1>; Маска для поиска файлов с тестами</span>
<span class=na>python_files</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>tests.py test_*.py *_tests.py</span>

<span class=c1>; Позволяет выводить логи (logs) в консоль при запуске тестов.</span>
<span class=na>log_cli</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>true</span>
</code></pre></div> <ol> <li>Создать файл <code>app/conftest.py</code></li> </ol> <div class=highlight><pre><span></span><code><span class=kn>from</span> <span class=nn>app.core.config</span> <span class=kn>import</span> <span class=n>TEST_DATABASE_URL</span>
<span class=kn>from</span> <span class=nn>fastapi_accelerator.db.dbsession</span> <span class=kn>import</span> <span class=n>MainDatabaseManager</span>

<span class=c1># Вы можете указать точный список импорта, это для простоты мы импортируем все</span>
<span class=kn>from</span> <span class=nn>fastapi_accelerator.testutils</span> <span class=kn>import</span> <span class=o>*</span>  <span class=c1># noqa E402</span>

<span class=c1># Нужно создать менеджер БД до импорта APP</span>
<span class=c1># чтобы паттерн одиночка создал только тестовое instance</span>
<span class=c1># и в APP уже взялся тестовый instance</span>
<span class=n>TestDatabaseManager</span> <span class=o>=</span> <span class=n>MainDatabaseManager</span><span class=p>(</span>
    <span class=n>TEST_DATABASE_URL</span><span class=p>,</span> <span class=n>echo</span><span class=o>=</span><span class=kc>False</span><span class=p>,</span> <span class=n>DEV_STATUS</span><span class=o>=</span><span class=kc>True</span>
<span class=p>)</span>

<span class=kn>from</span> <span class=nn>main</span> <span class=kn>import</span> <span class=n>app</span>  <span class=c1># noqa E402</span>

<span class=c1># Отключить кеширование во время тестов</span>
<span class=n>app</span><span class=o>.</span><span class=n>state</span><span class=o>.</span><span class=n>CACHE_STATUS</span> <span class=o>=</span> <span class=kc>False</span>

<span class=n>SettingTest</span><span class=p>(</span><span class=n>TestDatabaseManager</span><span class=p>,</span> <span class=n>app</span><span class=p>,</span> <span class=n>alembic_migrate</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span> <span class=n>keepdb</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span> <span class=c1># noqa F405</span>
</code></pre></div> <h2 id=_3>Основные компоненты для тестирования</h2> <p>Для упрощения написания тестов, их стандартизацию, вы можете использовать следующие компоненты:</p> <ul> <li> <p>Фикстуры:</p> <ul> <li><code>client</code> - Клиент для выполнения тестовых API запросов</li> <li><code>test_app</code> - Тестовое FastAPI приложение</li> <li><code>url_path_for</code> - Получить полный URL путь, по имени функции обработчика</li> <li><code>engine</code> - Синхронный двигатель</li> <li><code>aengine</code> - Асинхронный двигатель</li> <li><code>db_session</code> - Соединение с тестовой БД</li> <li><code>db_manager</code> - Менеджер с тестовой БД</li> </ul> </li> <li> <p>Функции:</p> <ul> <li><code>check_response_json</code> - Функция, которая объединяет основные проверки для API ответа</li> <li><code>rm_key_from_deep_dict</code> - Функция для отчистить не нужные ключи у API ответа</li> </ul> </li> <li> <p>Классы:</p> <ul> <li><code>BasePytest</code> - Базовый класс для тестирования через классы</li> <li><code>BaseAuthJwtPytest</code> - Добавление аутентификации по JWT(<code>@client_auth_jwt</code>) для <code>BasePytest</code></li> </ul> </li> <li> <p>Контекстный менеджер:</p> <ul> <li><code>track_queries</code> - Перехват выполняемых SQL команд, во время контекста, для последующего анализ - например подсчёта количества.</li> </ul> </li> <li> <p>Декораторы:</p> <ul> <li><code>@apply_fixture_db(ФункцияВозвращающаяФикстуры)</code> - Декоратор, который добавляет фикстуры в БД перед тестом и удаляет их после теста.</li> <li><code>@client_auth_jwt()</code> - Декоратор который аутентифицирует тестового клиента по JWT.</li> <li><code>@patch_integration(ПравилаПодмены)</code> - Декоратор который подменяет методы интеграций на Mock функции.</li> </ul> </li> </ul> <h2 id=_4>Подробнее про компоненты для тестирования</h2> <h3 id=fixture-client>Fixture - <code>client</code></h3> <p>Основная фикстура для выполнения тестовых API запросов.</p> <p>Порядок работы фикстуры <code>client</code>:</p> <ul> <li> <p>Этапы на уровней всей тестовой сессии:</p> <ol> <li>(before) Создастся тестовая БД если её нет;</li> <li> <p>(before) В зависимости от настройки <code>SettingTest.alembic_migrate</code>;</p> <ul> <li>Если <code>True</code> -&gt; Создаст таблицы через миграции <code>alembic</code></li> <li>Если <code>False</code> -&gt; Создаст таблицы через <code>create_all()</code></li> </ul> </li> <li> <p>(after) После завершение всех тестов, в зависимости от настройки <code>SettingTest.keepdb</code>;</p> <ul> <li>Если <code>True</code> -&gt; Ничего</li> <li>Если <code>False</code> -&gt; Удаляться все таблицы из тестовой БД</li> </ul> </li> </ol> </li> <li> <p>Этапы на уровней каждого тестового функции/метода:</p> <ol> <li>В тестовую функцию/метода попадает аргумент <code>client: TestClient</code>;</li> <li>(after) После выхода из тестовой функции/метода, все данных во всех таблицах отчищаются(кроме таблицы <code>alembic_version</code>, так как саму БД мы не удаляем);</li> </ol> </li> </ul> <div class=highlight><pre><span></span><code><span class=kn>from</span> <span class=nn>fastapi.testclient</span> <span class=kn>import</span> <span class=n>TestClient</span>

<span class=k>def</span> <span class=nf>test_имя</span><span class=p>(</span><span class=n>client</span><span class=p>:</span> <span class=n>TestClient</span><span class=p>):</span>
    <span class=n>response</span> <span class=o>=</span> <span class=n>client</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;url&#39;</span><span class=p>)</span>
</code></pre></div> <h3 id=decorator-client_auth_jwt>Decorator - <code>@client_auth_jwt</code></h3> <p>На практике нам часто приходиться тестировать API методы которые требуют аутентификацию. Делать обход аутентификации в тестах плохой вариант, так как можно упустить некоторые исключения, или логику API метода которая завязана на данных аутентифицированного пользователя. Поэтому чтобы аутентифицировать тестового клиента, укажите декоратор <code>@client_auth_jwt</code> для тестовой функции/метода</p> <ul> <li>Пример использование декоратора для тестовой функции:</li> </ul> <div class=highlight><pre><span></span><code><span class=kn>from</span> <span class=nn>fastapi.testclient</span> <span class=kn>import</span> <span class=n>TestClient</span>
<span class=kn>from</span> <span class=nn>fastapi_accelerator.testutils.fixture_auth</span> <span class=kn>import</span> <span class=n>client_auth_jwt</span>

<span class=nd>@client_auth_jwt</span><span class=p>(</span><span class=n>username</span><span class=o>=</span><span class=s1>&#39;test&#39;</span><span class=p>)</span>
<span class=k>def</span> <span class=nf>test_имя</span><span class=p>(</span><span class=n>client</span><span class=p>:</span> <span class=n>TestClient</span><span class=p>):</span>
    <span class=nb>print</span><span class=p>(</span><span class=n>client</span><span class=o>.</span><span class=n>headers</span><span class=p>[</span><span class=s1>&#39;authorization&#39;</span><span class=p>])</span> <span class=c1># &#39;Bearer ...&#39;</span>
</code></pre></div> <ul> <li>Пример использование декоратора для тестового метода в классе <code>BasePytest</code>:</li> </ul> <div class=highlight><pre><span></span><code><span class=kn>from</span> <span class=nn>fastapi.testclient</span> <span class=kn>import</span> <span class=n>TestClient</span>
<span class=kn>from</span> <span class=nn>fastapi_accelerator.testutils.fixture_base</span> <span class=kn>import</span> <span class=n>BasePytest</span>
<span class=kn>from</span> <span class=nn>fastapi_accelerator.testutils.fixture_auth</span> <span class=kn>import</span> <span class=n>client_auth_jwt</span>

<span class=k>class</span> <span class=nc>TestИмяКласса</span><span class=p>(</span><span class=n>BasePytest</span><span class=p>):</span>

    <span class=nd>@client_auth_jwt</span><span class=p>()</span>
    <span class=k>def</span> <span class=nf>test_имя</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>client</span><span class=p>:</span> <span class=n>TestClient</span><span class=p>):</span>
        <span class=nb>print</span><span class=p>(</span><span class=n>client</span><span class=o>.</span><span class=n>headers</span><span class=p>[</span><span class=s1>&#39;authorization&#39;</span><span class=p>])</span> <span class=c1># &#39;Bearer ...&#39;</span>
</code></pre></div> <blockquote> <p>Если вы используете декоратор <code>@client_auth_jwt</code> в классе <code>BasePytest</code>, то он возьмет <code>username</code> из <code>self.TEST_USER['username']</code>, этот атрибут уже определен в <code>BasePytest</code> и равен по умолчанию <code>test</code>.</p> </blockquote> <h3 id=decorator-apply_fixture_db>Decorator - <code>@apply_fixture_db</code></h3> <p>Идея взята из тестирования <code>Django</code>, в котором можно указать в атрибуте <code>fixtures</code> список файлов с фикстурами, которые будут загружены для тестов, и удалены после окончания. Этот очень удобно для переиспользовать тестовых данных.</p> <p>Но я решил модифицировать этот вариант и сделать фикстуры не в виде <code>JSON</code> а виде объектов <code>SqlAlchemy</code>. Использование <code>JSON</code> лучше когда нужно переносить эти данные на другие платформы, но такое встречается редко, чаще всего фикстуры для backend тестов используются только на backend, и горазда удобнее и быстрее писать в формате объектов БД, чем в формате <code>JSON</code>. Поэтому выбран формат объектов.</p> <p>Порядок работы декоратора <code>@apply_fixture_db</code>:</p> <ol> <li>Получает записи из переданной функции <code>export_func</code>;</li> <li>Создает записи в БД;</li> <li>Выполняется тестовая функция. Если она ожидает аргумент <code>fixtures</code>, то в него передадутся записи из <code>export_func</code>;</li> <li>Удаляет записи из БД:<ul> <li>Если вы используете фикстуру <code>client</code>, то она автоматически отчистить все данные в таблицах, после выполнения тестовой функции.</li> <li>Если вы не используете фикстуру <code>client</code>, то для отчистки данных укажите в декоратор аргумент <code>flush=True</code></li> </ul> </li> </ol> <hr> <ul> <li>Оформление файлами с тестовыми данными <code>app.fixture.items_v1.py</code>:</li> </ul> <div class=highlight><pre><span></span><code><span class=kn>from</span> <span class=nn>fastapi_accelerator.utils</span> <span class=kn>import</span> <span class=n>to_namedtuple</span>
<span class=kn>from</span> <span class=nn>app.models.timemeasurement</span> <span class=kn>import</span> <span class=n>Task</span><span class=p>,</span> <span class=n>TaskExecution</span><span class=p>,</span> <span class=n>TaskUser</span>

<span class=k>def</span> <span class=nf>export_fixture_task</span><span class=p>():</span>
    <span class=c1># Создание пользователей и задач</span>
    <span class=n>user1</span> <span class=o>=</span> <span class=n>TaskUser</span><span class=p>(</span><span class=nb>id</span><span class=o>=</span><span class=mi>0</span><span class=p>,</span> <span class=n>name</span><span class=o>=</span><span class=s2>&quot;Alice&quot;</span><span class=p>)</span>
    <span class=n>user2</span> <span class=o>=</span> <span class=n>TaskUser</span><span class=p>(</span><span class=nb>id</span><span class=o>=</span><span class=mi>1</span><span class=p>,</span> <span class=n>name</span><span class=o>=</span><span class=s2>&quot;Bob&quot;</span><span class=p>)</span>

    <span class=n>task1</span> <span class=o>=</span> <span class=n>Task</span><span class=p>(</span><span class=nb>id</span><span class=o>=</span><span class=mi>9</span><span class=p>,</span> <span class=n>name</span><span class=o>=</span><span class=s2>&quot;Admins&quot;</span><span class=p>)</span>
    <span class=n>task2</span> <span class=o>=</span> <span class=n>Task</span><span class=p>(</span><span class=nb>id</span><span class=o>=</span><span class=mi>8</span><span class=p>,</span> <span class=n>name</span><span class=o>=</span><span class=s2>&quot;Users&quot;</span><span class=p>)</span>

    <span class=c1># Связывание пользователей с задачами</span>
    <span class=n>user1</span><span class=o>.</span><span class=n>tasks</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>task1</span><span class=p>)</span>
    <span class=n>user2</span><span class=o>.</span><span class=n>tasks</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>task1</span><span class=p>)</span>
    <span class=n>user2</span><span class=o>.</span><span class=n>tasks</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>task2</span><span class=p>)</span>

    <span class=c1># Вернуть именований картеж</span>
    <span class=k>return</span> <span class=n>to_namedtuple</span><span class=p>(</span>
        <span class=n>user1</span><span class=o>=</span><span class=n>user1</span><span class=p>,</span>
        <span class=n>user2</span><span class=o>=</span><span class=n>user2</span><span class=p>,</span>
        <span class=n>task1</span><span class=o>=</span><span class=n>task1</span><span class=p>,</span>
        <span class=n>task2</span><span class=o>=</span><span class=n>task2</span><span class=p>,</span>
        <span class=n>task_execution1</span><span class=o>=</span><span class=n>TaskExecution</span><span class=p>(</span>
            <span class=nb>id</span><span class=o>=</span><span class=mi>91</span><span class=p>,</span>
            <span class=n>task</span><span class=o>=</span><span class=n>task1</span><span class=p>,</span>
            <span class=n>start_time</span><span class=o>=</span><span class=s2>&quot;2024-09-06T10:55:43&quot;</span><span class=p>,</span>
            <span class=n>end_time</span><span class=o>=</span><span class=s2>&quot;2024-09-06T10:59:43&quot;</span><span class=p>,</span>
        <span class=p>),</span>
    <span class=p>)</span>
</code></pre></div> <ul> <li>Использование декоратора в тестовых функциях:</li> </ul> <div class=highlight><pre><span></span><code><span class=kn>from</span> <span class=nn>fastapi_accelerator.test_utils</span> <span class=kn>import</span> <span class=n>apply_fixture_db</span>
<span class=kn>from</span> <span class=nn>app.fixture.items_v1</span> <span class=kn>import</span> <span class=n>export_fixture_task</span>

<span class=nd>@apply_fixture_db</span><span class=p>(</span><span class=n>export_fixture_task</span><span class=p>)</span>
<span class=k>def</span> <span class=nf>test_имя</span><span class=p>(</span><span class=n>client</span><span class=p>:</span> <span class=n>TestClient</span><span class=p>):</span>
    <span class=n>response</span> <span class=o>=</span> <span class=n>client</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;url&#39;</span><span class=p>)</span>
</code></pre></div> <ul> <li>Использование декоратора в тестовых методах, в этом варианте вы можно указывать только для <code>setUp</code>, тогда он будет применен для всех тестовых методов:</li> </ul> <div class=highlight><pre><span></span><code><span class=kn>from</span> <span class=nn>fastapi.testclient</span> <span class=kn>import</span> <span class=n>TestClient</span>
<span class=kn>from</span> <span class=nn>fastapi_accelerator.testutils.fixture_base</span> <span class=kn>import</span> <span class=n>BasePytest</span>
<span class=kn>from</span> <span class=nn>fastapi_accelerator.test_utils</span> <span class=kn>import</span> <span class=n>apply_fixture_db</span>
<span class=kn>from</span> <span class=nn>app.fixture.items_v1</span> <span class=kn>import</span> <span class=n>export_fixture_task</span>

<span class=k>class</span> <span class=nc>TestИмяКласса</span><span class=p>(</span><span class=n>BasePytest</span><span class=p>):</span>

    <span class=nd>@apply_fixture_db</span><span class=p>(</span><span class=n>export_fixture_task</span><span class=p>)</span>
    <span class=k>def</span> <span class=nf>setUp</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>fixtures</span><span class=p>:</span> <span class=n>NamedTuple</span><span class=p>):</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>fixtures</span> <span class=o>=</span> <span class=n>fixtures</span>

    <span class=k>def</span> <span class=nf>test_имя</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>client</span><span class=p>:</span> <span class=n>TestClient</span><span class=p>):</span>
        <span class=n>response</span> <span class=o>=</span> <span class=n>client</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;url&#39;</span><span class=p>)</span>
        <span class=nb>print</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>fixtures</span><span class=p>)</span>
</code></pre></div> <h3 id=decorator-patch_integration>Decorator - <code>@patch_integration</code></h3> <p>Тестирование интеграций с внешними API</p> <p>Самым сложным аспектом тестирования являются интеграции с внешними API, поскольку во время тестов необходимо избегать выполнения реальных запросов к этим API. Поэтому нам приходится самостоятельно разрабатывать логику для имитации работы внешнего API. Хотя наша имитация может не полностью отражать реальную работу API, это все же лучше, чем игнорировать интеграцию.</p> <p>В командах часто каждый разработчик создает свои собственные моки для интеграций, что приводит к путанице и отсутствию единого стандарта. Существует высокая вероятность ошибок, когда мок может не сработать, и произойдет отправка запроса в реальный API.</p> <p>Для решения этой проблемы мы используем классы интеграции <code>EndpointsDeclaration</code> с декоратором <code>@integration.endpoint</code>, что позволяет создать единую точку входа, которую можно легко заменить во время тестирования и исключить возможность выполнения реального метода интеграции.</p> <p>Пример тестирования метода <code>FastAPI</code>, который вызывает метод интеграции:</p> <ul> <li>Обработчик FastAPI:</li> </ul> <div class=highlight><pre><span></span><code><span class=nd>@router</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&quot;/translate&quot;</span><span class=p>)</span>
<span class=k>async</span> <span class=k>def</span> <span class=nf>translate_api</span><span class=p>(</span>
    <span class=n>text</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>from_lang</span><span class=p>:</span> <span class=nb>str</span> <span class=o>=</span> <span class=s2>&quot;en&quot;</span><span class=p>,</span> <span class=n>to_lang</span><span class=p>:</span> <span class=nb>str</span> <span class=o>=</span> <span class=s2>&quot;ru&quot;</span>
<span class=p>)</span> <span class=o>-&gt;</span> <span class=n>GoogleTranslateEndpoints</span><span class=o>.</span><span class=n>Schema</span><span class=o>.</span><span class=n>TranslateV2</span><span class=p>:</span>
    <span class=c1># Вызвать метод интеграции</span>
    <span class=k>return</span> <span class=k>await</span> <span class=n>gtapi</span><span class=o>.</span><span class=n>translate</span><span class=p>(</span><span class=n>text</span><span class=p>,</span> <span class=n>from_lang</span><span class=p>,</span> <span class=n>to_lang</span><span class=p>)</span>
</code></pre></div> <ul> <li><code>test_имя.py</code> пример интеграции с <code>google</code> переводчик:</li> </ul> <div class=highlight><pre><span></span><code><span class=kn>from</span> <span class=nn>fastapi_accelerator.testutils.fixture_integration</span> <span class=kn>import</span> <span class=n>patch_integration</span>
<span class=kn>from</span> <span class=nn>app.integration.google_translate.mock</span> <span class=kn>import</span> <span class=n>google_translate_mock_rules</span>

<span class=c1># Правила подмены методов интеграции на mock.</span>
<span class=c1># Если в коде вызывается интеграция, которая не указана в mock_rules, возникает исключение.</span>
<span class=c1># Это предотвращает случайные реальные запросы, если вы забыли указать mock.</span>
<span class=nd>@patch_integration</span><span class=p>(</span><span class=n>mock_rules</span><span class=o>=</span><span class=n>google_translate_mock_rules</span><span class=p>)</span>
<span class=k>def</span> <span class=nf>test_integration_google_translate</span><span class=p>(</span><span class=n>client</span><span class=p>:</span> <span class=n>TestClient</span><span class=p>,</span> <span class=n>url_path_for</span><span class=p>:</span> <span class=n>Callable</span><span class=p>):</span>
    <span class=c1># Выполнение тестового запроса</span>
    <span class=n>response</span> <span class=o>=</span> <span class=n>client</span><span class=o>.</span><span class=n>get</span><span class=p>(</span>
        <span class=n>url_path_for</span><span class=p>(</span><span class=s2>&quot;translate_api&quot;</span><span class=p>),</span>
        <span class=n>params</span><span class=o>=</span><span class=nb>dict</span><span class=p>(</span><span class=n>text</span><span class=o>=</span><span class=s2>&quot;Hello&quot;</span><span class=p>,</span> <span class=n>from_lang</span><span class=o>=</span><span class=s2>&quot;en&quot;</span><span class=p>,</span> <span class=n>to_lang</span><span class=o>=</span><span class=s2>&quot;ru&quot;</span><span class=p>),</span>
    <span class=p>)</span>
    <span class=c1># Проверка ответа</span>
    <span class=k>assert</span> <span class=n>response</span><span class=o>.</span><span class=n>json</span><span class=p>()</span> <span class=o>==</span> <span class=p>{</span><span class=s2>&quot;text&quot;</span><span class=p>:</span> <span class=s2>&quot;Привет&quot;</span><span class=p>}</span>
</code></pre></div> <blockquote> <p>Значение для <code>mock_rules</code> можно использовать откуда угодно, но рекомендую хранить и брать из <code>app/integration/ПакетИнтеграции/mock.py</code></p> </blockquote> <ul> <li>Рекомендуется хранить подменные функции в одном пакете с интеграцией в <code>app/integration/ПакетИнтеграции/mock.py</code>, чтобы при импорте этого пакета в другой проект также можно было использовать функции из <code>mock.py</code>, не создавая свои имитации.</li> </ul> <div class=highlight><pre><span></span><code><span class=kn>from</span> <span class=nn>app.integration.google_translate.endpoint</span> <span class=kn>import</span> <span class=n>GoogleTranslateEndpoints</span>
<span class=kn>from</span> <span class=nn>fastapi_accelerator.integration.http_integration</span> <span class=kn>import</span> <span class=n>ApiHTTP</span>
<span class=kn>from</span> <span class=nn>fastapi_accelerator.testutils.fixture_integration</span> <span class=kn>import</span> <span class=n>MockRules</span>


<span class=k>async</span> <span class=k>def</span> <span class=nf>overwrite_translate</span><span class=p>(</span><span class=n>api</span><span class=p>:</span> <span class=n>ApiHTTP</span><span class=p>,</span> <span class=o>*</span><span class=n>args</span><span class=p>,</span> <span class=o>**</span><span class=n>kwargs</span><span class=p>):</span>
    <span class=c1># Удобный вариант имитации, когда через match аргументов, возвращаем определенный ответ.</span>
    <span class=k>match</span> <span class=n>args</span><span class=p>:</span>
        <span class=k>case</span> <span class=p>(</span><span class=s2>&quot;hello&quot;</span><span class=p>,</span> <span class=s2>&quot;en&quot;</span><span class=p>,</span> <span class=s2>&quot;ru&quot;</span><span class=p>):</span>
            <span class=k>return</span> <span class=p>{</span><span class=s2>&quot;text&quot;</span><span class=p>:</span> <span class=s2>&quot;Привет&quot;</span><span class=p>}</span>
    <span class=k>return</span> <span class=kc>None</span>


<span class=c1># Правила замены методов интеграции на mock</span>
<span class=n>google_translate_mock_rules</span> <span class=o>=</span> <span class=n>MockRules</span><span class=p>(</span>
    <span class=c1># Реальный метод интеграции: замена на mock функцию</span>
    <span class=p>{</span><span class=n>GoogleTranslateEndpoints</span><span class=o>.</span><span class=n>translate</span><span class=p>:</span> <span class=n>overwrite_translate</span><span class=p>}</span>
<span class=p>)</span>
</code></pre></div> <blockquote> <p>К мок-функциям применяются те же требования к формату ответа, что и к реальному методу интеграции.</p> </blockquote> <h3 id=context-manager-track_queries>Context manager - <code>track_queries</code></h3> <p>Идея взята из тестирования <code>Django</code> метода <code>self.assertNumQueries</code>, который поваляет проверять количество выполненных SQL команд в контексте. Это очень полезно когда используется ORM, который может из за неаккуратного использования, генерировать сотни SQL команд. Поэтому лучше у каждого вызова тестового API метода отлеживать количество выполненных SQL команд.</p> <ul> <li>Пример использования контекстного менеджера <code>track_queries</code>:</li> </ul> <div class=highlight><pre><span></span><code><span class=kn>from</span> <span class=nn>fastapi_accelerator.testutils.fixture_db.trace_sql</span> <span class=kn>import</span> <span class=n>track_queries</span>

<span class=k>def</span> <span class=nf>test_имя</span><span class=p>(</span><span class=n>client</span><span class=p>:</span> <span class=n>TestClient</span><span class=p>,</span> <span class=n>db_manager</span><span class=p>:</span> <span class=n>MainDatabaseManager</span><span class=p>):</span>
    <span class=k>with</span> <span class=n>track_queries</span><span class=p>(</span><span class=n>db_manager</span><span class=p>,</span> <span class=n>expected_count</span><span class=o>=</span><span class=mi>3</span><span class=p>):</span>
        <span class=n>response</span> <span class=o>=</span> <span class=n>client</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;url&#39;</span><span class=p>)</span>
</code></pre></div> <ul> <li>Вы можете получить полный список выполненных SQL команд из <code>tracker.queries</code>:</li> </ul> <div class=highlight><pre><span></span><code><span class=kn>from</span> <span class=nn>fastapi_accelerator.testutils.fixture_db.trace_sql</span> <span class=kn>import</span> <span class=n>track_queries</span>

<span class=k>def</span> <span class=nf>test_имя</span><span class=p>(</span><span class=n>client</span><span class=p>:</span> <span class=n>TestClient</span><span class=p>,</span> <span class=n>db_manager</span><span class=p>:</span> <span class=n>MainDatabaseManager</span><span class=p>):</span>
    <span class=k>with</span> <span class=n>track_queries</span><span class=p>(</span><span class=n>db_manager</span><span class=p>)</span> <span class=k>as</span> <span class=n>tracker</span><span class=p>:</span>
        <span class=n>response</span> <span class=o>=</span> <span class=n>client</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;url&#39;</span><span class=p>)</span>

    <span class=c1># Если количество измениться, то выведется список всех выполненных SQL команд</span>
    <span class=k>assert</span> <span class=n>tracker</span><span class=o>.</span><span class=n>count</span> <span class=o>==</span> <span class=mi>3</span><span class=p>,</span> <span class=n>tracker</span><span class=o>.</span><span class=n>queries</span>
</code></pre></div> <h3 id=func-check_response_json>Func - <code>check_response_json</code></h3> <p>По опыту написания тестов, могу выделить несколько основных проверок для ответов API JSON.</p> <ol> <li>Проверить статус ответа</li> <li>Получить ответ в формате JSON</li> <li>Если нужно, то удалить динамические ключи из ответа, например дату создания, дату обновления, первичный ключ новой записи. Работает через функцию <code>rm_key_from_deep_dict</code></li> <li>Сравнить ответ с ожидаемым</li> </ol> <p>Эти проверки выполняются в функции <code>check_response_json</code></p> <p>Пример использования:</p> <div class=highlight><pre><span></span><code><span class=k>def</span> <span class=nf>test_имя</span><span class=p>(</span><span class=n>client</span><span class=p>:</span> <span class=n>TestClient</span><span class=p>):</span>
    <span class=n>response</span> <span class=o>=</span> <span class=n>client</span><span class=o>.</span><span class=n>post</span><span class=p>(</span><span class=s1>&#39;url&#39;</span><span class=p>,</span> <span class=n>json</span><span class=o>=</span><span class=p>{</span><span class=o>...</span><span class=p>})</span>
    <span class=n>check_response_json</span><span class=p>(</span>
        <span class=n>response</span><span class=p>,</span>
        <span class=mi>200</span><span class=p>,</span>
        <span class=p>{</span>
            <span class=s2>&quot;page&quot;</span><span class=p>:</span> <span class=mi>1</span><span class=p>,</span>
            <span class=s2>&quot;size&quot;</span><span class=p>:</span> <span class=mi>10</span><span class=p>,</span>
            <span class=s2>&quot;count&quot;</span><span class=p>:</span> <span class=mi>1</span><span class=p>,</span>
            <span class=s2>&quot;items&quot;</span><span class=p>:</span> <span class=p>[</span>
                <span class=p>{</span>
                    <span class=s2>&quot;end_time&quot;</span><span class=p>:</span> <span class=s2>&quot;2024-09-06T10:59:43&quot;</span><span class=p>,</span>
                    <span class=s2>&quot;start_time&quot;</span><span class=p>:</span> <span class=s2>&quot;2024-09-06T10:55:43&quot;</span><span class=p>,</span>
                    <span class=s2>&quot;task&quot;</span><span class=p>:</span> <span class=p>{</span>
                        <span class=s2>&quot;description&quot;</span><span class=p>:</span> <span class=kc>None</span><span class=p>,</span>
                        <span class=s2>&quot;name&quot;</span><span class=p>:</span> <span class=s2>&quot;Admins&quot;</span><span class=p>,</span>
                    <span class=p>},</span>
                <span class=p>}</span>
            <span class=p>],</span>
        <span class=p>},</span>
        <span class=n>exclude_list</span><span class=o>=</span><span class=p>[</span><span class=s1>&#39;id&#39;</span><span class=p>,</span><span class=s1>&#39;task_id&#39;</span><span class=p>]</span>
    <span class=p>)</span>
</code></pre></div> <h3 id=_5>Тестирование через классы</h3> <h4 id=basepytest>Класс <code>BasePytest</code></h4> <p>Удобнее и понятнее, создавать логически связанные тесты в одном классе, и указывать в методе <code>setUp</code> общую для них инициализацию, например общий url, или создание тестовых объектов в БД, или создание переменных хранящих ожидаемый JSON ответ.</p> <ul> <li>Пример создания класса для тестирования на основание <code>BasePytest</code>:</li> </ul> <div class=highlight><pre><span></span><code><span class=kn>from</span> <span class=nn>fastapi.testclient</span> <span class=kn>import</span> <span class=n>TestClient</span>
<span class=kn>from</span> <span class=nn>fastapi_accelerator.testutils.fixture_base</span> <span class=kn>import</span> <span class=n>BasePytest</span>

<span class=k>class</span> <span class=nc>TestИмяКласса</span><span class=p>(</span><span class=n>BasePytest</span><span class=p>):</span>

    <span class=k>def</span> <span class=nf>setUp</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
        <span class=c1># Метод для выполнения необходимой настройки перед каждым тестом.</span>
        <span class=o>...</span>

    <span class=k>def</span> <span class=nf>test_имя</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>client</span><span class=p>:</span> <span class=n>TestClient</span><span class=p>):</span>
        <span class=o>...</span>
</code></pre></div> <ul> <li>Вы можете использовать фикстуры и декораторы для тестовых методах, например аутентификаций по JWT:</li> </ul> <div class=highlight><pre><span></span><code><span class=kn>from</span> <span class=nn>fastapi.testclient</span> <span class=kn>import</span> <span class=n>TestClient</span>
<span class=kn>from</span> <span class=nn>fastapi_accelerator.testutils.fixture_base</span> <span class=kn>import</span> <span class=n>BasePytest</span>
<span class=kn>from</span> <span class=nn>fastapi_accelerator.testutils.fixture_auth</span> <span class=kn>import</span> <span class=n>client_auth_jwt</span>

<span class=k>class</span> <span class=nc>TestИмяКласса</span><span class=p>(</span><span class=n>BasePytest</span><span class=p>):</span>

    <span class=k>def</span> <span class=nf>setUp</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
        <span class=c1># Метод для выполнения необходимой настройки перед каждым тестом.</span>
        <span class=o>...</span>

    <span class=nd>@client_auth_jwt</span><span class=p>()</span>
    <span class=k>def</span> <span class=nf>test_имя</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>client</span><span class=p>:</span> <span class=n>TestClient</span><span class=p>):</span>
        <span class=nb>print</span><span class=p>(</span><span class=n>client</span><span class=o>.</span><span class=n>headers</span><span class=p>[</span><span class=s1>&#39;authorization&#39;</span><span class=p>])</span> <span class=c1># &#39;Bearer ...&#39;</span>
        <span class=o>...</span>
</code></pre></div> <h4 id=baseauthjwtpytest>Класс <code>BaseAuthJwtPytest</code></h4> <p>Чтобы не писать для каждого тестового метода в классе, декоратор <code>@client_auth_jwt</code> вы можете наследоваться от <code>BaseAuthJwtPytest</code>, в котором эта логика уже реализована.</p> <ul> <li>Пример создания класса для тестирования на основание <code>BaseAuthJwtPytest</code>:</li> </ul> <div class=highlight><pre><span></span><code><span class=kn>from</span> <span class=nn>fastapi.testclient</span> <span class=kn>import</span> <span class=n>TestClient</span>
<span class=kn>from</span> <span class=nn>fastapi_accelerator.testutils.fixture_base</span> <span class=kn>import</span> <span class=n>BaseAuthJwtPytest</span>

<span class=k>class</span> <span class=nc>TestИмяКласса</span><span class=p>(</span><span class=n>BaseAuthJwtPytest</span><span class=p>):</span>

    <span class=k>def</span> <span class=nf>setUp</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
        <span class=c1># Метод для выполнения необходимой настройки перед каждым тестом.</span>
        <span class=o>...</span>

    <span class=k>def</span> <span class=nf>test_имя</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>client</span><span class=p>:</span> <span class=n>TestClient</span><span class=p>):</span>
        <span class=nb>print</span><span class=p>(</span><span class=n>client</span><span class=o>.</span><span class=n>headers</span><span class=p>[</span><span class=s1>&#39;authorization&#39;</span><span class=p>])</span> <span class=c1># &#39;Bearer ...&#39;</span>
        <span class=o>...</span>
</code></pre></div> <h2 id=_6>Примеры тестов</h2> <h3 id=_7>Классическая тестовой функции</h3> <p>Проверки REST API метода, который использует РСУБД, и возвращает ответ в формате <code>JSON</code>:</p> <div class=highlight><pre><span></span><code><span class=kn>from</span> <span class=nn>typing</span> <span class=kn>import</span> <span class=n>Callable</span><span class=p>,</span> <span class=n>NamedTuple</span>

<span class=kn>from</span> <span class=nn>fastapi.testclient</span> <span class=kn>import</span> <span class=n>TestClient</span>

<span class=kn>from</span> <span class=nn>app.fixture.items_v1</span> <span class=kn>import</span> <span class=n>export_fixture_file</span>
<span class=kn>from</span> <span class=nn>fastapi_accelerator.db.dbsession</span> <span class=kn>import</span> <span class=n>MainDatabaseManager</span>
<span class=kn>from</span> <span class=nn>fastapi_accelerator.testutils</span> <span class=kn>import</span> <span class=n>apply_fixture_db</span><span class=p>,</span> <span class=n>client_auth_jwt</span><span class=p>,</span> <span class=n>track_queries</span><span class=p>,</span> <span class=n>check_response_json</span>

<span class=c1># Аутентифицировать тестового клиента</span>
<span class=nd>@client_auth_jwt</span><span class=p>(</span><span class=n>username</span><span class=o>=</span><span class=s2>&quot;test&quot;</span><span class=p>)</span>
<span class=c1># Создать тестовые данных из функции с фикстурами</span>
<span class=nd>@apply_fixture_db</span><span class=p>(</span><span class=n>export_fixture_file</span><span class=p>)</span>
<span class=k>def</span> <span class=nf>test_имя</span><span class=p>(</span>
    <span class=n>client</span><span class=p>:</span> <span class=n>TestClient</span><span class=p>,</span>  <span class=c1># Тестовый клиент для API запросов</span>
    <span class=n>url_path_for</span><span class=p>:</span> <span class=n>Callable</span><span class=p>,</span>  <span class=c1># Функция для получения url по имени функции обработчика</span>
    <span class=n>db_manager</span><span class=p>:</span> <span class=n>MainDatabaseManager</span><span class=p>,</span>  <span class=c1># Менеджер тестовой БД</span>
    <span class=n>fixtures</span><span class=p>:</span> <span class=n>NamedTuple</span><span class=p>,</span>  <span class=c1># Хранит созданные данные из фикстур</span>
<span class=p>):</span>
    <span class=c1># Проверка количество выполняемых SQL команд</span>
    <span class=k>with</span> <span class=n>track_queries</span><span class=p>(</span><span class=n>db_manager</span><span class=p>,</span> <span class=n>expected_count</span><span class=o>=</span><span class=mi>3</span><span class=p>):</span>
        <span class=c1># Запрос в API</span>
        <span class=n>response</span> <span class=o>=</span> <span class=n>client</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=n>url_path_for</span><span class=p>(</span><span class=s2>&quot;ИмяФункции&quot;</span><span class=p>))</span>
    <span class=c1># Проверка JSON API ответа</span>
    <span class=n>check_response_json</span><span class=p>(</span>
        <span class=n>response</span><span class=p>,</span>
        <span class=mi>200</span><span class=p>,</span>
        <span class=p>{</span>
            <span class=s2>&quot;id&quot;</span><span class=p>:</span> <span class=n>fixtures</span><span class=o>.</span><span class=n>Имя</span><span class=o>.</span><span class=n>id</span><span class=p>,</span>
        <span class=p>},</span>
    <span class=p>)</span>
    <span class=c1># TODO Можно для методов POST, UPDATE, DELETE добавить проверку на изменения записей в БД.</span>
    <span class=o>...</span>
</code></pre></div> <h3 id=_8>Классический тестовый класс</h3> <p>Проверки REST API метода, который использует РСУБД, и возвращает ответ в формате <code>JSON</code>:</p> <div class=highlight><pre><span></span><code><span class=kn>from</span> <span class=nn>typing</span> <span class=kn>import</span> <span class=n>Callable</span><span class=p>,</span> <span class=n>NamedTuple</span>

<span class=kn>from</span> <span class=nn>fastapi.testclient</span> <span class=kn>import</span> <span class=n>TestClient</span>

<span class=kn>from</span> <span class=nn>app.fixture.items_v1</span> <span class=kn>import</span> <span class=n>export_fixture_file</span>
<span class=kn>from</span> <span class=nn>fastapi_accelerator.db.dbsession</span> <span class=kn>import</span> <span class=n>MainDatabaseManager</span>
<span class=kn>from</span> <span class=nn>fastapi_accelerator.testutils</span> <span class=kn>import</span> <span class=n>apply_fixture_db</span>
<span class=kn>from</span> <span class=nn>fastapi_accelerator.testutils.fixture_auth</span> <span class=kn>import</span> <span class=n>client_auth_jwt</span>
<span class=kn>from</span> <span class=nn>fastapi_accelerator.testutils.fixture_db.trace_sql</span> <span class=kn>import</span> <span class=n>track_queries</span>
<span class=kn>from</span> <span class=nn>fastapi_accelerator.testutils.utils</span> <span class=kn>import</span> <span class=n>BaseAuthJwtPytest</span><span class=p>,</span> <span class=n>check_response_json</span>

<span class=n>BASE_URL_V1</span> <span class=o>=</span> <span class=s2>&quot;/api/v1/&quot;</span>

<span class=k>class</span> <span class=nc>TestИмя</span><span class=p>(</span><span class=n>BaseAuthJwtPytest</span><span class=p>):</span>

    <span class=c1># Создать тестовые данных из функции с фикстурами</span>
    <span class=nd>@apply_fixture_db</span><span class=p>(</span><span class=n>export_fixture_file</span><span class=p>)</span>
    <span class=k>def</span> <span class=nf>setUp</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>fixtures</span><span class=p>:</span> <span class=n>NamedTuple</span><span class=p>):</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>url</span> <span class=o>=</span> <span class=n>BASE_URL_V1</span> <span class=o>+</span> <span class=s2>&quot;taskexecution&quot;</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>fixtures</span> <span class=o>=</span> <span class=n>fixtures</span> <span class=c1># Хранит созданные данные из фикстур</span>

    <span class=k>def</span> <span class=nf>test_имя</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>client</span><span class=p>:</span> <span class=n>TestClient</span><span class=p>,</span> <span class=n>db_manager</span><span class=p>:</span> <span class=n>MainDatabaseManager</span><span class=p>):</span>
        <span class=c1># Проверка количество выполняемых SQL команд</span>
        <span class=k>with</span> <span class=n>track_queries</span><span class=p>(</span><span class=n>db_manager</span><span class=p>,</span> <span class=n>expected_count</span><span class=o>=</span><span class=mi>3</span><span class=p>):</span>
            <span class=c1># Запрос в API</span>
            <span class=n>response</span> <span class=o>=</span> <span class=n>client</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>url</span><span class=p>)</span>
        <span class=c1># Проверка JSON API ответа</span>
        <span class=n>check_response_json</span><span class=p>(</span>
            <span class=n>response</span><span class=p>,</span>
            <span class=mi>200</span><span class=p>,</span>
            <span class=p>{</span>
                <span class=s2>&quot;id&quot;</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>fixtures</span><span class=o>.</span><span class=n>Имя</span><span class=o>.</span><span class=n>id</span><span class=p>,</span>
            <span class=p>},</span>
        <span class=p>)</span>
        <span class=c1># TODO Можно для методов POST, UPDATE, DELETE добавить проверку на изменения записей в БД.</span>
        <span class=o>...</span>
</code></pre></div> </article> </div> <script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script> </div> </main> <footer class=md-footer> <div class="md-footer-meta md-typeset"> <div class="md-footer-meta__inner md-grid"> <div class=md-copyright> Made with <a href=https://squidfunk.github.io/mkdocs-material/ target=_blank rel=noopener> Material for MkDocs </a> </div> </div> </div> </footer> </div> <div class=md-dialog data-md-component=dialog> <div class="md-dialog__inner md-typeset"></div> </div> <script id=__config type=application/json>{"base": "..", "features": [], "search": "../assets/javascripts/workers/search.6ce7567c.min.js", "translations": {"clipboard.copied": "\u0421\u043a\u043e\u043f\u0438\u0440\u043e\u0432\u0430\u043d\u043e \u0432 \u0431\u0443\u0444\u0435\u0440", "clipboard.copy": "\u041a\u043e\u043f\u0438\u0440\u043e\u0432\u0430\u0442\u044c \u0432 \u0431\u0443\u0444\u0435\u0440", "search.result.more.one": "\u0415\u0449\u0451 1 \u043d\u0430 \u044d\u0442\u043e\u0439 \u0441\u0442\u0440\u0430\u043d\u0438\u0446\u0435", "search.result.more.other": "\u0415\u0449\u0451 # \u043d\u0430 \u044d\u0442\u043e\u0439 \u0441\u0442\u0440\u0430\u043d\u0438\u0446\u0435", "search.result.none": "\u0421\u043e\u0432\u043f\u0430\u0434\u0435\u043d\u0438\u0439 \u043d\u0435 \u043d\u0430\u0439\u0434\u0435\u043d\u043e", "search.result.one": "\u041d\u0430\u0439\u0434\u0435\u043d\u043e 1 \u0441\u043e\u0432\u043f\u0430\u0434\u0435\u043d\u0438\u0435", "search.result.other": "\u041d\u0430\u0439\u0434\u0435\u043d\u043e \u0441\u043e\u0432\u043f\u0430\u0434\u0435\u043d\u0438\u0439: #", "search.result.placeholder": "\u041d\u0430\u0447\u043d\u0438\u0442\u0435 \u043f\u0435\u0447\u0430\u0442\u0430\u0442\u044c \u0434\u043b\u044f \u043f\u043e\u0438\u0441\u043a\u0430", "search.result.term.missing": "\u041e\u0442\u0441\u0443\u0442\u0441\u0442\u0432\u0443\u0435\u0442", "select.version": "\u0412\u044b\u0431\u0435\u0440\u0438\u0442\u0435 \u0432\u0435\u0440\u0441\u0438\u044e"}}</script> <script src=../assets/javascripts/bundle.d6f25eb3.min.js></script> </body> </html>